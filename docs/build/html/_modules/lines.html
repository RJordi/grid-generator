<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lines &mdash; Austrian Transmission Grid  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Austrian Transmission Grid
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sources.html">Data Sources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Austrian Transmission Grid</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>lines</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lines</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">haversine</span> <span class="kn">import</span> <span class="n">haversine</span><span class="p">,</span> <span class="n">Unit</span>


<div class="viewcode-block" id="query_lines"><a class="viewcode-back" href="../api.html#lines.query_lines">[docs]</a><span class="k">def</span> <span class="nf">query_lines</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overpass API query to be run</span>

<span class="sd">    :param:</span>
<span class="sd">    :return: query string</span>
<span class="sd">    :rtype: str</span>

<span class="sd">    The query looks for lines and cables with a voltage value &gt;= 100kV inside the area of Austria and filters out</span>
<span class="sd">    the lines and cables with a frequency of 16.7Hz, which belong to the railway system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    // define output format</span>
<span class="s2">    [out:json];</span>

<span class="s2">    // gather results</span>
<span class="s2">    area[name=&quot;Ã–sterreich&quot;]-&gt;.searchArea;</span>
<span class="s2">    (</span>
<span class="s2">      nwr[&quot;power&quot;=&quot;line&quot;](if:(t[&quot;voltage&quot;]&gt;=100000) &amp;&amp; (t[&quot;frequency&quot;]!=16.7))(area.searchArea);</span>
<span class="s2">      nwr[&quot;power&quot;=&quot;cable&quot;](if:(t[&quot;voltage&quot;]&gt;=100000) &amp;&amp; (t[&quot;frequency&quot;]!=16.7))(area.searchArea);</span>
<span class="s2">    );</span>

<span class="s2">    // print results</span>
<span class="s2">    out body geom;</span>
<span class="s2">    &gt;;</span>
<span class="s2">      out tags;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">query</span></div>


<div class="viewcode-block" id="calculate_line_length"><a class="viewcode-back" href="../api.html#lines.calculate_line_length">[docs]</a><span class="k">def</span> <span class="nf">calculate_line_length</span><span class="p">(</span><span class="n">coords_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the length of a line</span>

<span class="sd">    :param coords_list: Coordinates that define the line</span>
<span class="sd">    :type coords_list: list(list(float, float))</span>
<span class="sd">    :return: The line&#39;s length value</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Accumulated sum of the haversine distance between consecutive coordinates of a line element</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_list</span><span class="p">)):</span>
        <span class="n">length</span> <span class="o">+=</span> <span class="n">haversine</span><span class="p">(</span><span class="n">coords_list</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">Unit</span><span class="o">.</span><span class="n">KILOMETERS</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">length</span></div>


<div class="viewcode-block" id="find_connecting_segments"><a class="viewcode-back" href="../api.html#lines.find_connecting_segments">[docs]</a><span class="k">def</span> <span class="nf">find_connecting_segments</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the ids of the ways containing the initial or final node from the given list of nodes</span>

<span class="sd">    :param  pd.Series row: row of the Series consisting of the nodes that belong to a line</span>
<span class="sd">    :param  pd.DataFrame df: lines DataFrame</span>
<span class="sd">    :return: list with ids of ways that contain the start or end node of row</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get start and end node of each line element</span>
    <span class="n">start_node</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_node</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Find ids of line elements containing the start node (includes the one from the line elements we are evaluating)</span>
    <span class="n">connecting_segments_start</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">start_node</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># Delete own id</span>
    <span class="n">connecting_segments_start</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># Filter out line elements that have different voltage from the evaluated line element</span>
    <span class="n">connecting_segments_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">connecting_segments_start</span> <span class="k">if</span>
                                 <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span> <span class="ow">or</span> <span class="s1">&#39;seg&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                                 <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">])]</span>
    <span class="n">connecting_segments_end</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">end_node</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">connecting_segments_end</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># delete own id</span>
    <span class="n">connecting_segments_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">connecting_segments_end</span> <span class="k">if</span>
                               <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span> <span class="ow">or</span> <span class="s1">&#39;seg&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">])]</span>
    <span class="c1"># Create a lists with the two lists</span>
    <span class="n">connecting_segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">connecting_segments_start</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">connecting_segments_end</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">connecting_segments</span></div>


<div class="viewcode-block" id="format_lines"><a class="viewcode-back" href="../api.html#lines.format_lines">[docs]</a><span class="k">def</span> <span class="nf">format_lines</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format lines DataFrame</span>

<span class="sd">    :param pd.DataFrame df: lines DataFrame</span>
<span class="sd">    :return: formatted lines DataFrame</span>
<span class="sd">    :rtype: pd.DataFrame</span>

<span class="sd">    Get relevant information from tags and put it in the DataFrame&#39;s columns. Calculate the length of each line</span>
<span class="sd">    using :func:`calculate_line_length` and compute each line&#39;s connecting line using :func:`find_connecting_segments`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set id of each element as the index of the DataFrame</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify_integrity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
    
    <span class="n">df_lines</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;way&#39;</span><span class="p">][[</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]]</span>

    <span class="c1"># Extract information from the &quot;nodes&quot; and &quot;geometry&quot; columns</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;n&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>

    <span class="c1"># Create columns from the information in the &quot;tags&quot; column</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;voltage&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;line&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cables&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;circuits&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ref&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>

    <span class="c1"># Handle special cases &quot;manually&quot; where OSM data is incorrect</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;w1062744814&#39;</span><span class="p">,</span> <span class="s1">&#39;w1062744811&#39;</span><span class="p">,</span> <span class="s1">&#39;w1062744812&#39;</span><span class="p">,</span> <span class="s1">&#39;w1062744815&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;w0000000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;n9749839070&#39;</span><span class="p">,</span> <span class="s1">&#39;n9762978976&#39;</span><span class="p">,</span> <span class="s1">&#39;n9762978973&#39;</span><span class="p">,</span> <span class="s1">&#39;n9762978971&#39;</span><span class="p">,</span> <span class="s1">&#39;n1097093519&#39;</span><span class="p">],</span>
                               <span class="p">[[</span><span class="mf">47.4928261</span><span class="p">,</span> <span class="mf">11.9614425</span><span class="p">],[</span><span class="mf">47.4829992</span><span class="p">,</span> <span class="mf">11.9340746</span><span class="p">],[</span><span class="mf">47.4820233</span><span class="p">,</span> <span class="mf">11.9304848</span><span class="p">],[</span><span class="mf">47.4783881</span><span class="p">,</span> <span class="mf">11.9370183</span><span class="p">],[</span><span class="mf">47.4754292</span><span class="p">,</span> <span class="mf">11.9404947</span><span class="p">]],</span>
                               <span class="p">{},</span> <span class="s1">&#39;manually added&#39;</span><span class="p">,</span> <span class="s1">&#39;110000&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;176/1A;176/2A&#39;</span><span class="p">]</span>

    <span class="c1"># Calculate length and connecting segments of each line element</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calculate_line_length</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;connecting_segments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">find_connecting_segments</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_lines</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Drop &quot;tags&quot; column because it&#39;s no more useful and drop entries which don&#39;t have any digit in the &quot;voltage&quot; column</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Remove duplicated lines (different instances with same geometry)</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_lines</span></div>


<div class="viewcode-block" id="handle_nan"><a class="viewcode-back" href="../api.html#lines.handle_nan">[docs]</a><span class="k">def</span> <span class="nf">handle_nan</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fill NaN data in the DataFrame columns</span>

<span class="sd">    :param pd.DataFrame df_lines: lines pd.DataFrame</span>
<span class="sd">    :return: lines DataFrame without NaN values</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># default=&#39;warn&#39;</span>
    
    <span class="c1"># Handle nan in &quot;cables&quot; -&gt; use number of references to determine number of cables</span>
    <span class="n">nan_cables</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
    <span class="n">nan_cables_known_ref</span> <span class="o">=</span> <span class="n">nan_cables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nan_cables</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nan_cables_known_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nan_cables_known_ref</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span>
    
    <span class="c1"># Use potentially known number of cables in the following line segment</span>
    <span class="n">nan_cables</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>  <span class="c1"># Define &quot;nan_cables&quot; again as some entries have been solved</span>
    
    <span class="k">def</span> <span class="nf">look_for_cables</span><span class="p">(</span><span class="n">segments</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segments</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segments</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nan_cables</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nan_cables</span><span class="o">.</span><span class="n">connecting_segments</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">look_for_cables</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_lines</span><span class="p">))</span>
    
    <span class="c1"># Set the cables to 3 for the rest of the entries (these entries have small length)</span>
    <span class="n">nan_cables</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nan_cables</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    
    <span class="c1"># Handle nan in &quot;circuits&quot;</span>
    <span class="c1"># -&gt; use values in &quot;cables&quot; (if it is a multiple of 3) to calculate missing values in &quot;circuits&quot;</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">circuits</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">/</span><span class="mi">3</span>
    
    <span class="c1"># Handle nan in &quot;name&quot; -&gt; fill nan values with an empty string</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_lines</span></div>


<div class="viewcode-block" id="correct_incoherent_cables"><a class="viewcode-back" href="../api.html#lines.correct_incoherent_cables">[docs]</a><span class="k">def</span> <span class="nf">correct_incoherent_cables</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct incoherent data in the cables column</span>

<span class="sd">    :param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">    :return: lines DataFrame without incoherent cables</span>
<span class="sd">    :rtype: pd.DataFrame</span>

<span class="sd">    The number of cables should always be a multiple of 3 because we are considering that all circuits are 3-phased</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Case where the references are known</span>
    <span class="n">incoherent_cables</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">incoherent_cables</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">incoherent_cables</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span>
    
    <span class="c1"># Case where references are unknown -&gt; the rest of lines have very short lengths, we give them a &quot;cables&quot; value of 3</span>
    <span class="n">incoherent_cables</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">incoherent_cables</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    
    <span class="c1"># Use values in &quot;cables&quot; (if it is a multiple of 3) to calculate missing values in &quot;circuits&quot;</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">circuits</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">/</span><span class="mi">3</span>
    
    <span class="k">return</span> <span class="n">df_lines</span></div>


<div class="viewcode-block" id="correct_incoherent_combinations"><a class="viewcode-back" href="../api.html#lines.correct_incoherent_combinations">[docs]</a><span class="k">def</span> <span class="nf">correct_incoherent_combinations</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct incoherent data between columns</span>

<span class="sd">    :param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">    :return: lines DataFrame without incoherent data</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Number_of_circuits != Number_of_references</span>
    <span class="n">diff_ref_circuits</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">circuits</span> <span class="o">!=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
    
    <span class="n">unlikely_circuits</span> <span class="o">=</span> <span class="n">diff_ref_circuits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_ref_circuits</span><span class="o">.</span><span class="n">circuits</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Lines with an unlikely number of circuits (&gt;3 circuits)</span>
    <span class="n">short_ways</span> <span class="o">=</span> <span class="n">diff_ref_circuits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_ref_circuits</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># Short lines (&lt;0.2 km)</span>
    <span class="n">long_ways</span> <span class="o">=</span> <span class="n">diff_ref_circuits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_ref_circuits</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># Longer lines (&gt;0.2 km)</span>

    <span class="c1"># Assign the number of references as the number of circuits for the &quot;unlikely_circuits&quot;</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">unlikely_circuits</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unlikely_circuits</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
    <span class="c1"># Assign the minimum between the number of circuits and the number of references for short lines</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">short_ways</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">short_ways</span><span class="o">.</span><span class="n">circuits</span><span class="p">,</span> <span class="n">short_ways</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Assign the maximum between the number of circuits and the number of references for longer lines</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">long_ways</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">long_ways</span><span class="o">.</span><span class="n">circuits</span><span class="p">,</span> <span class="n">long_ways</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Number_of_cables != Number_of_circuits*3</span>
    <span class="n">diff_cables_circuits</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">cables</span><span class="o">/</span><span class="mi">3</span> <span class="o">!=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">circuits</span><span class="p">)]</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_cables_circuits</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_cables_circuits</span><span class="o">.</span><span class="n">cables</span><span class="o">/</span><span class="mi">3</span>
    
    <span class="k">return</span> <span class="n">df_lines</span></div>

<div class="viewcode-block" id="split_lines_by_voltage"><a class="viewcode-back" href="../api.html#lines.split_lines_by_voltage">[docs]</a><span class="k">def</span> <span class="nf">split_lines_by_voltage</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split lines with more than one voltage level into multiple lines (one for each voltage level)</span>

<span class="sd">    :param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">    :return: lines DataFrame containing lines with a single voltage level per line</span>
<span class="sd">    :rtype: pd.DataFrame</span>

<span class="sd">    When the number of voltage levels is the same as the number of circuits a line is assigned to each voltage level</span>
<span class="sd">    (a line here is equivalent to a row of the DataFrame). When the number of voltage levels is different from the</span>
<span class="sd">    number of circuits we distinguish two cases:</span>

<span class="sd">    * **number_of_circuits % number_of_voltage_levels == 0**: we assign a line to each voltage level, but now the</span>
<span class="sd">      line has a number of circuits equal to: ::</span>

<span class="sd">        number_of_circuits / number_of_voltage_levels</span>
<span class="sd">    * **number_of_circuits % number_of_voltage_levels != 0**: we look if the references are known (there&#39;s one</span>
<span class="sd">      reference for each circuit):</span>

<span class="sd">      * **references are known**: we assign a line to each voltage level and the number of determined by the references</span>
<span class="sd">      * **references are not known**:  TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">multi_volt_lines</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># case where there are the same number of voltage levels as circuits</span>
    <span class="n">same_circuits</span> <span class="o">=</span> <span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">circuits</span><span class="p">]</span>
    <span class="n">repeated_idxs</span> <span class="o">=</span> <span class="n">same_circuits</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">same_circuits</span><span class="o">.</span><span class="n">circuits</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">s_c_duplicated</span> <span class="o">=</span> <span class="n">same_circuits</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">repeated_idxs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">aux_func</span><span class="p">(</span><span class="n">row</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">num_duplicates_row</span> <span class="o">=</span> <span class="n">repeated_idxs</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">voltage</span> <span class="o">=</span> <span class="p">[</span><span class="n">volt</span> <span class="k">for</span> <span class="n">volt</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">circuits</span> <span class="o">-</span> <span class="n">num_duplicates_row</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">circuits</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">circuits</span> <span class="o">-</span> <span class="n">num_duplicates_row</span><span class="p">)]</span>
        <span class="n">row</span><span class="o">.</span><span class="n">cables</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">circuits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">repeated_idxs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>
    
    <span class="n">s_c_duplicated</span> <span class="o">=</span> <span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">aux_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">new_index</span> <span class="o">=</span> <span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;kV&#39;</span>
    <span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_c_duplicated</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">110000</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
     
    <span class="n">df_lines</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">s_c_duplicated</span><span class="p">))</span>
    
    <span class="c1"># case where the number of voltage levels is different from the number of circuits</span>
    
    <span class="n">mvl_diff_circ</span> <span class="o">=</span> <span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">!=</span> <span class="n">multi_volt_lines</span><span class="o">.</span><span class="n">circuits</span><span class="p">]</span>
    
    <span class="n">repeated_idxs</span> <span class="o">=</span> <span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">diff_circ_duplicated</span> <span class="o">=</span> <span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">repeated_idxs</span><span class="p">)</span>

        <span class="c1"># case where number_of_circuits % number_of_voltage_levels == 0</span>
    <span class="n">mvl_div</span> <span class="o">=</span> <span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">circuits</span><span class="o">%</span><span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">volt</span> <span class="o">=</span> <span class="n">mvl_div</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">circuits</span> <span class="o">=</span> <span class="n">mvl_div</span><span class="o">.</span><span class="n">circuits</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="c1">#     l_new = []</span>
<span class="c1">#     for i in range(len(volt)):</span>
<span class="c1">#         for elem in volt[i]:</span>
<span class="c1">#             for e in range(int(circuits[i]/len(volt[i]))):</span>
<span class="c1">#                 l_new.append(elem)</span>
    <span class="n">v_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volt</span><span class="p">))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">volt</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">circ_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">circuits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">volt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volt</span><span class="p">))</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">volt</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">cable_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">circ</span><span class="o">*</span><span class="mi">3</span> <span class="k">for</span> <span class="n">circ</span> <span class="ow">in</span> <span class="n">circ_new</span><span class="p">]</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_div</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_div</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">circ_new</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_div</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cable_new</span>

        <span class="c1"># case where number_of_circuits % number_of_voltage_levels != 0</span>
    <span class="n">mvl_non_div</span> <span class="o">=</span> <span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">circuits</span><span class="o">%</span><span class="n">mvl_diff_circ</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># case where the references are known</span>
    <span class="n">mvl_ref</span> <span class="o">=</span> <span class="n">mvl_non_div</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_non_div</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="n">mvl_non_div</span><span class="o">.</span><span class="n">circuits</span><span class="p">]</span>
    <span class="n">ref_first_num</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">]</span> <span class="k">for</span> <span class="n">refs</span> <span class="ow">in</span> <span class="n">mvl_ref</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>
    <span class="n">ref_first_num_unique</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ref_first_num</span><span class="p">]</span>
    <span class="n">ref_first_num_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_first_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ref_first_num_unique</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_first_num</span><span class="p">))</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_first_num_unique</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
    <span class="n">volt</span> <span class="o">=</span> <span class="n">mvl_ref</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">v_new</span> <span class="o">=</span> <span class="n">volt</span>
    <span class="c1">#v_new = [volt[i] for i in range(len(volt)) for x in range(ref_first_num_count[i])]</span>
    <span class="n">circ_new</span> <span class="o">=</span> <span class="n">ref_first_num_count</span>
    <span class="n">cable_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">circ</span><span class="o">*</span><span class="mi">3</span> <span class="k">for</span> <span class="n">circ</span> <span class="ow">in</span> <span class="n">circ_new</span><span class="p">]</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">circ_new</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cable_new</span>
            <span class="c1"># case where the references are NOT known</span>
    <span class="n">mvl_non_ref</span> <span class="o">=</span> <span class="n">mvl_non_div</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_non_div</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">!=</span> <span class="n">mvl_non_div</span><span class="o">.</span><span class="n">circuits</span><span class="p">]</span>
    <span class="n">volt</span> <span class="o">=</span> <span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">circuits</span> <span class="o">=</span> <span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">circuits</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">floor_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">circuits</span><span class="o">//</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">div_residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">circuits</span><span class="o">%</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">v_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volt</span><span class="p">))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">volt</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">circ_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volt</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">volt</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">circ_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">floor_div</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">div_residual</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">cable_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">circ</span><span class="o">*</span><span class="mi">3</span> <span class="k">for</span> <span class="n">circ</span> <span class="ow">in</span> <span class="n">circ_new</span><span class="p">]</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">circ_new</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mvl_non_ref</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cable_new</span>

<span class="c1">#     diff_circ_duplicated.cables = 3</span>
<span class="c1">#     diff_circ_duplicated.circuits = 1</span>
    <span class="n">new_index</span> <span class="o">=</span> <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;kV&#39;</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_circ_duplicated</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">110000</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df_lines</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">diff_circ_duplicated</span><span class="p">))</span>

    <span class="c1"># Format voltage value</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span> <span class="o">==</span> <span class="mf">400.0</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">380.0</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span> <span class="o">==</span> <span class="mf">132.0</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">110.0</span>
    <span class="c1"># Calculate connecting segments again as we have changed the ids of some entries</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;connecting_segments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">find_connecting_segments</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_lines</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Put index into &quot;id&quot; column</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">index</span>

    <span class="k">return</span> <span class="n">df_lines</span></div>

<div class="viewcode-block" id="split_middle_connections"><a class="viewcode-back" href="../api.html#lines.split_middle_connections">[docs]</a><span class="k">def</span> <span class="nf">split_middle_connections</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split lines that are connected to other lines at some point which is not its start or end</span>

<span class="sd">    :param ps.DataFrame df: lines DataFrame</span>
<span class="sd">    :return: lines DataFrame without any middle connection</span>
<span class="sd">    :rtype: pd.DataFrame</span>

<span class="sd">    TODO -&gt; More detailed explanation of what the function does</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">connecting_segments</span><span class="p">]</span>
    <span class="n">df_l</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
    <span class="n">lines_to_split</span><span class="p">,</span> <span class="n">where_to_split</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">connecting_segments_col</span> <span class="o">=</span> <span class="n">df_l</span><span class="o">.</span><span class="n">connecting_segments</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">nodes_col</span> <span class="o">=</span> <span class="n">df_l</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">nodes_col_all</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">idx_col_all</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connecting_segments_col</span><span class="p">)):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">connecting_segments_col</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">connecting_line_id</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">connecting_line_id_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx_col_all</span><span class="o">==</span><span class="n">connecting_line_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">connecting_node</span> <span class="o">=</span> <span class="n">nodes_col</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">connecting_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">nodes_col_all</span><span class="p">[</span><span class="n">connecting_line_id_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">nodes_col_all</span><span class="p">[</span><span class="n">connecting_line_id_idx</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]:</span>
                    <span class="n">lines_to_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connecting_line_id</span><span class="p">)</span>
                    <span class="n">where_to_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connecting_node</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">df_lines_to_split</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lines_to_split</span><span class="p">]</span>
    <span class="c1">#display(df_lines_to_split.head())</span>
    <span class="n">index_where_to_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">where_to_split</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines_to_split</span><span class="p">))]</span>

    <span class="c1"># Handle cases where there is more than ONE line connecting to a middle node</span>
    <span class="n">df_lines_to_split</span><span class="p">[</span><span class="s1">&#39;where_to_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">where_to_split</span>
    <span class="n">df_lines_to_split</span><span class="p">[</span><span class="s1">&#39;idx_where_to_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_where_to_split</span>
    <span class="n">df_lines_to_split</span> <span class="o">=</span> <span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;where_to_split&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                                             <span class="s1">&#39;idx_where_to_split&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())})</span>

    <span class="n">nodes_col_split</span><span class="p">,</span> <span class="n">geometry_col_split</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">splitted_nodes</span><span class="p">,</span> <span class="n">splitted_geometry</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">idx_where_to_split</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)):</span>
        <span class="n">splitted_nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nodes_col_split</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">nodes_col_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">nodes_col_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]]</span>
        <span class="n">splitted_geometry</span> <span class="o">+=</span> <span class="p">[</span><span class="n">geometry_col_split</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">geometry_col_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">geometry_col_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]]</span>

    <span class="n">new_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_seg_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_lines_to_split</span><span class="p">))</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">)]</span>

    <span class="n">df_to_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">splitted_nodes</span><span class="p">,</span> <span class="n">splitted_geometry</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">new_index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
    <span class="n">new_index_id</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">new_index</span><span class="p">]</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_index_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_index_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_index_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;cables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_index_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">circuits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_index_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_index_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_to_concat</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_to_concat</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calculate_line_length</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lines_to_split</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_lines</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_to_concat</span><span class="p">])</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;connecting_segments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">find_connecting_segments</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_lines</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Set new index</span>
    <span class="n">new_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;ElmLne_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">df_lines</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_lines</span></div>


<div class="viewcode-block" id="join_lines"><a class="viewcode-back" href="../api.html#lines.join_lines">[docs]</a><span class="k">def</span> <span class="nf">join_lines</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Join two line elements that are exclusively connected between each other</span>

<span class="sd">    :param pd.DataFrame df: lines DataFrame</span>
<span class="sd">    :return: lines DataFrame with concatenated lines</span>
<span class="sd">    :rtype: pd.DataFrame</span>

<span class="sd">    TODO: Detailed explanation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

    <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="nb">any</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">substations</span><span class="p">]</span>
    <span class="n">df_join</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
    <span class="n">line_ids</span> <span class="o">=</span> <span class="n">df_join</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">line_connections</span> <span class="o">=</span> <span class="n">df_join</span><span class="o">.</span><span class="n">connecting_segments</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">lines_subs</span> <span class="o">=</span> <span class="n">df_join</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">final_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">recursive_join</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">j_list</span><span class="p">:</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">line_connections</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j_list</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">lines_subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">line_connections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">segment</span><span class="p">)]):</span>
                <span class="n">j_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">recursive_join</span><span class="p">(</span><span class="n">line_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">j_list</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="n">j_list</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line_ids</span><span class="p">)):</span>
        <span class="n">join_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">recursive_join</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">join_list</span><span class="p">)))</span> <span class="c1">#why do I sort the list?</span>

    <span class="n">ser_chains</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">final_list</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ser_voltages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_terminals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>

    <span class="n">inconsistent_voltages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inconsistent_terminals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inconsistent_terminals_2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ser_chains</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ser_voltages</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inconsistent_voltages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1">#print(i, ser_chains[i], ser_terminals[i])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">ser_terminals</span><span class="p">[</span><span class="n">i</span><span class="p">]]):</span>
            <span class="n">inconsistent_terminals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">ser_terminals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">inconsistent_terminals_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># print(&#39;inconsistent_voltages: &#39;, inconsistent_voltages, &#39;len = &#39;, len(inconsistent_voltages))</span>
    <span class="c1"># print(&#39;inconsistent_terminals: &#39;, inconsistent_terminals, &#39;len = &#39;, len(inconsistent_terminals))</span>
    <span class="c1"># print(&#39;Examples: &#39;, ser_chains[inconsistent_terminals[7:12]], ser_terminals[inconsistent_terminals[7:12]])</span>
    <span class="c1"># print(&#39;inconsistent_terminals_2: &#39;, inconsistent_terminals_2, &#39;len = &#39;, len(inconsistent_terminals_2))</span>

    <span class="c1"># Create new entry in df for each list in series and drop the entries that appear in the list</span>
    <span class="n">ser_voltages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_circuits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">circuits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_terminals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_lengths</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_geometry</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>
    <span class="n">ser_ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>

    <span class="c1"># Order coordinates to chain segments in order</span>
    <span class="n">ordered_ser_geometry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ser_geom_elem</span> <span class="ow">in</span> <span class="n">ser_geometry</span><span class="p">:</span>
        <span class="n">start_end_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_list</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">ser_geom_elem</span><span class="p">]</span>
        <span class="n">start_end_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">start_end_points</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">]</span>
        <span class="n">unique_start_end_points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">start_end_points</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1">#assert len(unique_start_end_points) == 2, (ser_geom_elem, start_end_points,unique_start_end_points)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_start_end_points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># print(ser_chains[ser_geometry.tolist().index(ser_geom_elem)])</span>
            <span class="n">ordered_ser_geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ser_geom_elem</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">start_point</span> <span class="o">=</span> <span class="n">unique_start_end_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_point</span> <span class="o">=</span> <span class="n">unique_start_end_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#print(&#39;Start point: &#39;, start_point, &#39;\n&#39;)</span>

        <span class="k">def</span> <span class="nf">recursive_func</span><span class="p">(</span><span class="n">s_p</span><span class="p">,</span> <span class="n">new_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">ser_geom_elem</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s_p</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s_p</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">c_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="c1">#print(ser_geom_elem[ser_geom_elem.index(c_list)], &#39;\n&#39;)</span>
                    <span class="k">del</span> <span class="n">ser_geom_elem</span><span class="p">[</span><span class="n">ser_geom_elem</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c_list</span><span class="p">)]</span>
                    <span class="n">new_start</span> <span class="o">=</span> <span class="n">c_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span>
                    <span class="k">break</span>
<span class="c1">#             print(&#39;Updated start point \n&#39;, new_start, &#39;\n&#39;)</span>
<span class="c1">#             print(&#39;Updated ser_geom_elem \n&#39;, ser_geom_elem, &#39;\n&#39;)</span>
<span class="c1">#             print(&#39;Updated new_list \n&#39;, new_list, &#39;\n&#39;)</span>
            <span class="k">if</span> <span class="n">ser_geom_elem</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">recursive_func</span><span class="p">(</span><span class="n">new_start</span><span class="p">,</span> <span class="n">new_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_list</span>

        <span class="n">new_geom_elem</span> <span class="o">=</span> <span class="n">recursive_func</span><span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1">#print(&#39;new_geom_elem: &#39;, new_geom_elem)</span>
        <span class="n">ordered_ser_geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_geom_elem</span><span class="p">))</span>

    <span class="n">ser_geometry</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ordered_ser_geometry</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">ser_geometry</span> <span class="o">=</span> <span class="n">ser_geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># Create dataframe for the chained lines</span>
    <span class="n">df_chains</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="s1">&#39;cables&#39;</span><span class="p">,</span><span class="s1">&#39;circuits&#39;</span><span class="p">,</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span><span class="s1">&#39;length&#39;</span><span class="p">,</span><span class="s1">&#39;connecting_segments&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;substations&#39;</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">next</span><span class="p">((</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">elem</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ser_names</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">node</span> <span class="k">for</span> <span class="n">n_list</span> <span class="ow">in</span> <span class="n">ser_nodes_elem</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">n_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">ser_nodes_elem</span> <span class="ow">in</span> <span class="n">ser_nodes</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="n">coords</span> <span class="k">for</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">ser_geom_elem</span> <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">]</span> \
                                       <span class="k">for</span> <span class="n">ser_geom_elem</span> <span class="ow">in</span> <span class="n">ser_geometry</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">voltages</span><span class="p">)</span> <span class="k">for</span> <span class="n">voltages</span> <span class="ow">in</span> <span class="n">ser_voltages</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;circuits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">circuits</span><span class="p">)</span> <span class="k">for</span> <span class="n">circuits</span> <span class="ow">in</span> <span class="n">ser_circuits</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="k">for</span> <span class="n">lengths</span> <span class="ow">in</span> <span class="n">ser_lengths</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;substations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">elem</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">term</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ser_terminals</span><span class="p">]</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">ser_ids</span><span class="p">])</span>
    <span class="n">df_chains</span><span class="p">[</span><span class="s1">&#39;connecting_segments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;chained_line&#39;</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">ser_chains</span><span class="p">])</span>

    <span class="n">max_elm_lines_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">new_index_df_chains</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;ElmLne_</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="n">max_elm_lines_idx</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_chains</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">df_chains</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index_df_chains</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_join</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_chains</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Vettoretti Denis, Basel Morsy, Ribas Sobreviela Jordi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>