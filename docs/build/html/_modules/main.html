<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main &mdash; Austrian Transmission Grid  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Austrian Transmission Grid
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sources.html">Data Sources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Austrian Transmission Grid</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for main</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">LineString</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">transform</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">haversine</span> <span class="kn">import</span> <span class="n">haversine_vector</span><span class="p">,</span> <span class="n">Unit</span>

<span class="kn">import</span> <span class="nn">power_plants</span>
<span class="kn">import</span> <span class="nn">lines</span>
<span class="kn">import</span> <span class="nn">terminals</span>
<span class="kn">import</span> <span class="nn">tests</span>
<span class="kn">import</span> <span class="nn">validate</span>


<div class="viewcode-block" id="query_overpass"><a class="viewcode-back" href="../api.html#main.query_overpass">[docs]</a><span class="k">def</span> <span class="nf">query_overpass</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Query Overpass API</span>

<span class="sd">	:param str query: query</span>
<span class="sd">	:return: response with relevant information</span>
<span class="sd">	:rtype: pd.DataFrame</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">OVERPASS_URL</span> <span class="o">=</span> <span class="s2">&quot;http://overpass-api.de/api/interpreter&quot;</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OVERPASS_URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>
	<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">df</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not query data from Overpass API. Given response is: &#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_lines_in_subs"><a class="viewcode-back" href="../api.html#main.delete_lines_in_subs">[docs]</a><span class="k">def</span> <span class="nf">delete_lines_in_subs</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Delete lines that start and end inside the same substation</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: substations DataFrame</span>
<span class="sd">	:return: lines DataFrame with some lines deleted</span>
<span class="sd">	:rtype: pd.DataFrame</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">end_nodes_in_sub</span><span class="p">(</span><span class="n">coords_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="c1"># Get only substations which have a defined area (avoid using substations which are nodes)</span>
		<span class="n">sub_areas</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_subs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="c1"># Get starting and ending points of the line element</span>
		<span class="n">start_point_line</span><span class="p">,</span> <span class="n">end_point_line</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">coords_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">Point</span><span class="p">(</span><span class="n">coords_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="c1"># Iterate through all substations and return True if the starting and the ending point are inside it</span>
		<span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">sub_areas</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">start_point_line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">area</span><span class="p">))</span> <span class="ow">and</span> <span class="n">end_point_line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">area</span><span class="p">)):</span>
				<span class="k">return</span> <span class="kc">True</span>
		<span class="k">return</span> <span class="kc">False</span>

	<span class="c1"># Get lines which start and end in a substation and drop them from the lines DataFrame</span>
	<span class="n">lines_in_subs</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">end_nodes_in_sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">))]</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">lines_in_subs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="c1"># Calculate connecting segments again as we have deleted some lines</span>
	<span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;connecting_segments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lines</span><span class="o">.</span><span class="n">find_connecting_segments</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df_lines</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">df_lines</span></div>


<div class="viewcode-block" id="assign_substation_to_lines"><a class="viewcode-back" href="../api.html#main.assign_substation_to_lines">[docs]</a><span class="k">def</span> <span class="nf">assign_substation_to_lines</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Assign terminal to line end if this one is geometrically inside the terminal</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: substations DataFrame</span>
<span class="sd">	:return: lines DataFrame with assigned terminals</span>
<span class="sd">	:rtype: pd.DataFrame</span>
<span class="sd">	:return: substations DataFrame with corresponding terminals</span>
<span class="sd">	:rtype: pd.DataFrame</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">lines_geometry</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	<span class="n">lines_voltage</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	<span class="n">terminals_index</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	<span class="n">terminals_geometry</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	<span class="n">terminals_voltage</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

	<span class="n">new_terminals_index</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">new_terminals_voltage</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">new_terminals_geometry</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">assign_substation</span><span class="p">(</span><span class="n">lines_geometry</span><span class="p">,</span> <span class="n">lines_voltage</span><span class="p">,</span> <span class="n">terminals_index</span><span class="p">,</span> <span class="n">terminals_geometry</span><span class="p">,</span> <span class="n">terminals_voltage</span><span class="p">):</span>
		<span class="c1">#lines_substations = np.empty(shape=(len(lines_geometry),2), dtype=object).tolist()</span>
		<span class="n">lines_substations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines_geometry</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i_l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines_geometry</span><span class="p">)):</span>
			<span class="n">assigned_subs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
			<span class="c1">#assigned_subs = [np.nan, np.nan]</span>
			<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
				<span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lines_geometry</span><span class="p">[</span><span class="n">i_l</span><span class="p">][</span><span class="n">e</span><span class="p">])</span>
				<span class="k">for</span> <span class="n">i_t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">)):</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># case where the substation is only one node</span>
						<span class="k">if</span> <span class="n">point</span> <span class="o">==</span> <span class="n">Point</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
							<span class="n">assigned_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">terminals_index</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span>
							<span class="k">break</span>
					<span class="k">else</span><span class="p">:</span> <span class="c1"># case where the substation is a way or a relation</span>
						<span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">])):</span>
							<span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">))</span> <span class="k">if</span> <span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span><span class="o">==</span><span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
							<span class="k">if</span> <span class="n">lines_voltage</span><span class="p">[</span><span class="n">i_l</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">terminals_voltage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">]:</span>
								<span class="n">idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="k">if</span> <span class="n">lines_voltage</span><span class="p">[</span><span class="n">i_l</span><span class="p">]</span> <span class="o">==</span> <span class="n">terminals_voltage</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
								<span class="n">assigned_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">terminals_index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
								<span class="k">break</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="k">if</span> <span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span> <span class="ow">in</span> <span class="n">new_terminals_geometry</span><span class="p">:</span>
									<span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_terminals_geometry</span><span class="p">))</span> <span class="k">if</span> <span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span><span class="o">==</span><span class="n">new_terminals_geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
									<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">new_terminals_voltage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">lines_voltage</span><span class="p">[</span><span class="n">i_l</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">]):</span>
										<span class="n">idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="k">if</span> <span class="n">new_terminals_voltage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">lines_voltage</span><span class="p">[</span><span class="n">i_l</span><span class="p">])</span>
										<span class="n">assigned_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_terminals_index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
										<span class="k">break</span>
									<span class="k">else</span><span class="p">:</span>
										<span class="n">new_term_idx</span> <span class="o">=</span> <span class="s1">&#39;ElmTerm_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">terminals_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">new_terminals_index</span><span class="p">))</span>
										<span class="n">new_terminals_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_term_idx</span><span class="p">)</span>
										<span class="n">new_terminals_voltage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines_voltage</span><span class="p">[</span><span class="n">i_l</span><span class="p">])</span>
										<span class="n">new_terminals_geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">])</span>
										<span class="n">assigned_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_term_idx</span>
										<span class="k">break</span>
								<span class="k">else</span><span class="p">:</span>
									<span class="n">new_term_idx</span> <span class="o">=</span> <span class="s1">&#39;ElmTerm_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">terminals_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">new_terminals_index</span><span class="p">))</span>
									<span class="n">new_terminals_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_term_idx</span><span class="p">)</span>
									<span class="n">new_terminals_voltage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines_voltage</span><span class="p">[</span><span class="n">i_l</span><span class="p">])</span>
									<span class="n">new_terminals_geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terminals_geometry</span><span class="p">[</span><span class="n">i_t</span><span class="p">])</span>
									<span class="n">assigned_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_term_idx</span>
									<span class="k">break</span>

			<span class="n">lines_substations</span><span class="p">[</span><span class="n">i_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">assigned_subs</span>
		<span class="k">return</span> <span class="n">lines_substations</span>

	<span class="n">df_lines</span><span class="p">[</span><span class="s1">&#39;substations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_substation</span><span class="p">(</span><span class="n">lines_geometry</span><span class="p">,</span> <span class="n">lines_voltage</span><span class="p">,</span> <span class="n">terminals_index</span><span class="p">,</span> <span class="n">terminals_geometry</span><span class="p">,</span> <span class="n">terminals_voltage</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="c1"># Append new terminals to the substations DataFrame</span>
	<span class="n">df_new_terminals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;added terminal voltage&#39;</span><span class="p">,</span><span class="s1">&#39;voltage&#39;</span><span class="p">:</span><span class="n">new_terminals_voltage</span><span class="p">,</span>
									 <span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="n">new_terminals_geometry</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39; &#39;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">new_terminals_index</span><span class="p">)</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_subs</span><span class="p">,</span> <span class="n">df_new_terminals</span><span class="p">])</span>

	<span class="c1"># Leave out all substations that are not connected to any line</span>
	<span class="n">used_subs</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">used_subs</span><span class="p">]</span>

	<span class="k">return</span> <span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span></div>

<div class="viewcode-block" id="assign_substation_to_power_plants"><a class="viewcode-back" href="../api.html#main.assign_substation_to_power_plants">[docs]</a><span class="k">def</span> <span class="nf">assign_substation_to_power_plants</span><span class="p">(</span><span class="n">df_pp</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Assign the closest terminal to each power plant</span>

<span class="sd">	:param pd.DataFrame df_pp: power plants DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: terminals DataFrame</span>
<span class="sd">	:return:</span>
<span class="sd">		* **df_pp** (*pd.DataFrame*) - power plants DataFrame with assigned terminals</span>
<span class="sd">		* **df_pp_agg** (*pd.DataFrame*) - power plants DataFrame with assigned terminals and aggregated capacity</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">u_terminals</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_subs</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;virtual terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;tieline terminal&#39;</span><span class="p">])]</span>
	<span class="n">point_terminals</span> <span class="o">=</span> <span class="n">u_terminals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">u_terminals</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">polygon_terminals</span> <span class="o">=</span> <span class="n">u_terminals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">u_terminals</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">u_terminals_centroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">point_terminals</span><span class="p">,</span> <span class="n">polygon_terminals</span><span class="p">])</span>
	<span class="n">pp_centroids</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_pp</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">df_pp</span><span class="o">.</span><span class="n">lon</span><span class="p">)]</span>
	<span class="c1"># nt stands for &quot;nearest terminal&quot;</span>
	<span class="n">nt_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">haversine_vector</span><span class="p">(</span><span class="n">pp_centroids</span><span class="p">,</span> <span class="n">u_terminals_centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">unit</span><span class="o">=</span><span class="n">Unit</span><span class="o">.</span><span class="n">KILOMETERS</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">nt_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">haversine_vector</span><span class="p">(</span><span class="n">pp_centroids</span><span class="p">,</span> <span class="n">u_terminals_centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">unit</span><span class="o">=</span><span class="n">Unit</span><span class="o">.</span><span class="n">KILOMETERS</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

	<span class="n">pp_assigned_terminals</span> <span class="o">=</span> <span class="p">[</span><span class="n">u_terminals_centroids</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt_idx</span><span class="p">]</span>
	<span class="n">pp_dist_to_terminal</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">nt_dist</span><span class="p">]</span>

	<span class="n">df_pp</span><span class="p">[</span><span class="s1">&#39;assigned_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_assigned_terminals</span>
	<span class="n">df_pp</span><span class="p">[</span><span class="s1">&#39;dist_to_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_dist_to_terminal</span>

	<span class="c1"># #  Aggregate (sum) capacities for Wind and PV power plants that belong to the same terminal</span>
	<span class="c1"># df_pp_solar_wind = df_pp.loc[df_pp.template.isin([&#39;Wind&#39;, &#39;PV&#39;])]</span>
	<span class="c1"># grouped_df = df_pp_solar_wind.groupby([&#39;template&#39;, &#39;assigned_term&#39;], as_index=False).agg({&#39;name&#39;: lambda x:&#39;aggregated_pp&#39;,</span>
	<span class="c1"># 																						&#39;lat&#39;: lambda x: &#39;agg&#39;,</span>
	<span class="c1"># 																						&#39;lon&#39;: lambda x: &#39;agg&#39;,</span>
	<span class="c1"># 																						&#39;OSM type&#39;: lambda x:&#39;agg&#39;,</span>
	<span class="c1"># 																						&#39;power&#39;: lambda x:&#39;agg&#39;, &#39;capacity(MW)&#39;: &#39;sum&#39;,</span>
	<span class="c1"># 																						&#39;dist_to_term&#39;: lambda x:&#39;agg&#39;, &#39;source&#39;: lambda x: list(x)[0]})</span>
	<span class="c1"># df_pp_agg = df_pp.drop(df_pp_solar_wind.duplicated(subset=[&#39;template&#39;, &#39;assigned_term&#39;], keep=False).index, inplace=False)</span>
	<span class="c1"># df_pp_agg = pd.concat([df_pp_agg, grouped_df])</span>

	<span class="c1"># Aggregate (sum) capacities for all power plants that have a capacity &lt;= 10MW (considered distributed generation)</span>
	<span class="n">df_pp_distrib</span> <span class="o">=</span> <span class="n">df_pp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pp</span><span class="p">[</span><span class="s1">&#39;capacity(MW)&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">]</span>
	<span class="n">grouped_df</span> <span class="o">=</span> <span class="n">df_pp_distrib</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned_term&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;aggregated_pp&#39;</span><span class="p">,</span>
																							<span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;agg&#39;</span><span class="p">,</span>
																							<span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;agg&#39;</span><span class="p">,</span>
																							<span class="s1">&#39;OSM type&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span>
																							<span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;capacity(MW)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
																							<span class="s1">&#39;dist_to_term&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]})</span>

	<span class="n">df_pp_agg</span> <span class="o">=</span> <span class="n">df_pp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_pp_distrib</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned_term&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_pp_agg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pp_agg</span><span class="p">,</span> <span class="n">grouped_df</span><span class="p">])</span>

	<span class="k">return</span> <span class="n">df_pp</span><span class="p">,</span> <span class="n">df_pp_agg</span></div>


<div class="viewcode-block" id="create_virtual_terminals"><a class="viewcode-back" href="../api.html#main.create_virtual_terminals">[docs]</a><span class="k">def</span> <span class="nf">create_virtual_terminals</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create virtual terminals at points where more than 2 lines meet</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: terminals DataFrame</span>
<span class="sd">	:return: lines DataFrame with assigned virtual terminals</span>
<span class="sd">	:rtype: pd.DataFrame</span>
<span class="sd">	:return: terminals DataFrame with new virtual terminals appended</span>
<span class="sd">	:rtype: pd.DataFrame</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">line_idx</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">index</span>
	<span class="n">conn_seg</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">connecting_segments</span><span class="o">.</span><span class="n">values</span>
	<span class="n">subs</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">values</span>
	<span class="n">lines_w_vt</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_idx</span><span class="p">))</span> <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_seg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">==</span><span class="kc">True</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])]</span>
	<span class="n">df1</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lines_w_vt</span><span class="p">]</span> <span class="c1">#lines that need a virtual terminal</span>
	<span class="n">conn_seg_df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">connecting_segments</span><span class="o">.</span><span class="n">values</span>
	<span class="n">subs_df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">values</span>
	<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;fake_term_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_seg_df1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">subs_df1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">==</span><span class="kc">True</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df1</span><span class="p">))]</span>
	<span class="c1">#df1[&#39;fake_term_idx&#39;] = df1.connecting_segments.apply(lambda x: [-x.index(segment) for segment in x if len(segment)&gt;=2])</span>

	<span class="n">df_helper</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;fake_term_idx&#39;</span><span class="p">]]</span>
	<span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;lat_start&#39;</span><span class="p">],</span> <span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;lon_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">df1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;lat_end&#39;</span><span class="p">],</span> <span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;lon_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">df1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;fake_term_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">connecting_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">fake_term_idx</span> <span class="k">else</span> <span class="p">[],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;fake_term_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">connecting_segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">fake_term_idx</span> <span class="k">else</span> <span class="p">[],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

	<span class="n">geometry</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">fake_term_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
	<span class="n">df_fake_terms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
	<span class="n">df_fake_terms</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_fake_terms</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
	<span class="n">df_fake_terms</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">df_fake_terms</span> <span class="o">=</span> <span class="n">df_fake_terms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_fake_terms</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
	<span class="n">df_fake_terms</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;virtual terminal&#39;</span>
	<span class="n">new_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;ElmTerm_virtual_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fake_terms</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
	<span class="n">df_fake_terms</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="n">helper_geom</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_helper</span><span class="o">.</span><span class="n">lat_start</span><span class="p">,</span> <span class="n">df_helper</span><span class="o">.</span><span class="n">lon_start</span><span class="p">,</span> <span class="n">df_helper</span><span class="o">.</span><span class="n">lat_end</span><span class="p">,</span> <span class="n">df_helper</span><span class="o">.</span><span class="n">lon_end</span><span class="p">)]</span>
	<span class="n">df_helper</span><span class="p">[</span><span class="s1">&#39;fake_term_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">df_fake_terms</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="p">(</span><span class="n">df_fake_terms</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">helper_geom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">df_fake_terms</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">==</span><span class="n">df_helper</span><span class="o">.</span><span class="n">voltage</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">helper_geom</span><span class="p">))]</span>

	<span class="c1"># Add virtual terminals to the corresponding entries in the lines DataFrame</span>
	<span class="n">new_series_list</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">virt_term</span><span class="p">,</span> <span class="n">way_subs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_helper</span><span class="o">.</span><span class="n">fake_term_idx</span><span class="p">,</span> <span class="n">df_helper</span><span class="o">.</span><span class="n">fake_term_id</span><span class="p">,</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_helper</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">substations</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">way_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]):</span>
				<span class="n">way_subs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_term</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
		<span class="n">new_series_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">way_subs</span><span class="p">)</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_helper</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">substations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">new_series_list</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_helper</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

	<span class="c1"># Add virtual terminals to the substations DataFrame</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_subs</span><span class="p">,</span> <span class="n">df_fake_terms</span><span class="p">])</span>

	<span class="k">return</span> <span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span></div>


<div class="viewcode-block" id="handle_floating_ends"><a class="viewcode-back" href="../api.html#main.handle_floating_ends">[docs]</a><span class="k">def</span> <span class="nf">handle_floating_ends</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Assign a terminal to line ends which are still not connected anywhere</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: terminals DataFrame</span>
<span class="sd">	:returns:</span>
<span class="sd">		* **df_lines** (*pd.DataFrame*) - lines DataFrame with assigned floating end terminals</span>
<span class="sd">		* **df_subs** (*pd.DataFrame*) - terminals DataFrame with new floating end terminals appended</span>

<span class="sd">	Get lines with at least a floating end. If they have a substation nearby (less than 1 km), assign substation to line and</span>
<span class="sd">	add the length value corresponding to the missing segment. Otherwise, add a new terminal to the floating end.</span>
<span class="sd">	If the line end is outside the region of Austria, the line is a tieline and a substation is added at the floating end.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">floating_lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="p">[]</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">connecting_segments</span><span class="p">,</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="p">)]</span>
	<span class="n">floating_lines_df</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">floating_lines</span><span class="p">]</span>
	<span class="n">non_virtual_subs</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_subs</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;virtual terminal&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_subs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
	<span class="n">non_virtual_subs</span><span class="p">[</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_virtual_subs</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">subs_coords</span> <span class="o">=</span> <span class="n">non_virtual_subs</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="n">austrian_polygon</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/maps/austrian_geometry.geojson&#39;</span><span class="p">)[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">austrian_polygon</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">austrian_polygon</span><span class="p">)</span>
	<span class="n">ser_list_tielines</span><span class="p">,</span> <span class="n">ser_list_new_terms</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
	<span class="n">max_elm_term_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">handle_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
			<span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">connecting_segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">substations</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
				<span class="n">floating_end_coords</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">Point</span><span class="p">(</span><span class="n">floating_end_coords</span><span class="p">)</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">austrian_polygon</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># handle tielines</span>
					<span class="n">ser_list_tielines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;tieline terminal&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">voltage</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">[</span><span class="n">floating_end_coords</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
					<span class="n">row</span><span class="o">.</span><span class="n">substations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ElmTerm_tieline_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ser_list_tielines</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">dist_vector</span> <span class="o">=</span> <span class="n">haversine_vector</span><span class="p">(</span><span class="n">floating_end_coords</span><span class="p">,</span> <span class="n">subs_coords</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">Unit</span><span class="o">.</span><span class="n">KILOMETERS</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="n">ns_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist_vector</span> <span class="o">==</span> <span class="n">dist_vector</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">ns_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">dist_vector</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">ns_dist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># assign the closest terminal if there is a terminal less that 1km from the end of the line</span>
						<span class="n">closest_term</span> <span class="o">=</span> <span class="n">non_virtual_subs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ns_idx</span><span class="p">]</span>
						<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">term</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">substations</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">closest_term</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
							<span class="n">closest_term_voltages</span> <span class="o">=</span> <span class="n">non_virtual_subs</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">closest_term</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">closest_term_voltages</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">voltage</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
								<span class="n">correct_closest_term</span> <span class="o">=</span> <span class="n">closest_term_voltages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">closest_term_voltages</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">voltage</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
								<span class="n">correct_ns_idx</span> <span class="o">=</span> <span class="n">ns_idx</span><span class="p">[</span><span class="n">closest_term</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">correct_closest_term</span><span class="p">)]</span>
								<span class="n">row</span><span class="o">.</span><span class="n">substations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">correct_closest_term</span>
								<span class="n">row</span><span class="o">.</span><span class="n">length</span> <span class="o">+=</span> <span class="n">ns_dist</span>
								<span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subs_coords</span><span class="p">[</span><span class="n">correct_ns_idx</span><span class="p">]))</span>
							<span class="k">else</span><span class="p">:</span>  <span class="c1"># assign new terminal at the end point</span>
								<span class="n">ser_list_new_terms</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;floating end terminal&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">voltage</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">[</span><span class="n">floating_end_coords</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
								<span class="n">row</span><span class="o">.</span><span class="n">substations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ElmTerm_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ser_list_new_terms</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_elm_term_idx</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>  <span class="c1"># drop lines if their closest terminal is a repeated one and is less than 1km away</span>
							<span class="n">row</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;drop_this_line&#39;</span>
					<span class="k">else</span><span class="p">:</span>  <span class="c1"># assign new terminal at the end point</span>
						<span class="n">ser_list_new_terms</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;floating end terminal&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">voltage</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">[</span><span class="n">floating_end_coords</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
						<span class="n">row</span><span class="o">.</span><span class="n">substations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ElmTerm_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ser_list_new_terms</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_elm_term_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">row</span>

	<span class="n">floating_lines_df</span> <span class="o">=</span> <span class="n">floating_lines_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">handle_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="c1"># display(floating_lines_df.loc[floating_lines_df.substations==&#39;drop_this_line&#39;]) # delete or comment afterwards</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">floating_lines_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">floating_lines_df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;drop_this_line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">floating_lines_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">floating_lines_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">floating_lines_df</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;drop_this_line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">floating_lines_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">floating_lines_df</span>

	<span class="n">tielines_subs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ser_list_tielines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>
	<span class="n">new_index_tielines_subs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;ElmTerm_tieline_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tielines_subs_df</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
	<span class="n">tielines_subs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index_tielines_subs_df</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="n">new_terms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ser_list_new_terms</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>
	<span class="n">new_index_new_terms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;ElmTerm_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">max_elm_term_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">new_terms_df</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
	<span class="n">new_terms_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_index_new_terms_df</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_subs</span><span class="p">,</span> <span class="n">tielines_subs_df</span><span class="p">,</span> <span class="n">new_terms_df</span><span class="p">])</span>

	<span class="k">return</span> <span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span></div>


<div class="viewcode-block" id="handle_special_cases"><a class="viewcode-back" href="../api.html#main.handle_special_cases">[docs]</a><span class="k">def</span> <span class="nf">handle_special_cases</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">,</span> <span class="n">df_trafos</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Handle observed troublesome cases &quot;manually&quot;</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: temrinals DataFrame</span>
<span class="sd">	:param pd.DataFrame df_trafos: transformers DataFrame</span>
<span class="sd">	:return:</span>
<span class="sd">		* **df_lines** (*pd.DataFrame*) - lines DataFrame with resolved troublesome cases</span>
<span class="sd">		* **df_subs** (*pd.DataFrame*) - terminals DataFrame with resolved troublesome cases</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># Drop useless bays and busbars</span>
	<span class="n">special_cases</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;bay&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">line</span><span class="o">==</span><span class="s1">&#39;busbar&#39;</span><span class="p">)]</span>
	<span class="n">ids</span> <span class="o">=</span> <span class="n">special_cases</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="n">to_drop</span> <span class="o">=</span> <span class="n">special_cases</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="nb">all</span><span class="p">([</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">special_cases</span><span class="o">.</span><span class="n">connecting_segments</span><span class="p">]]</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">to_drop</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="c1"># Drop lines that can&#39;t be connected to any terminal or line (considered as wrong data from OSM)</span>
	<span class="n">exploded_terms</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
	<span class="n">floating_terminals</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_subs</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;floating&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">non_floating_exploded_terms</span> <span class="o">=</span> <span class="n">exploded_terms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">exploded_terms</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">floating_terminals</span><span class="p">)]</span>
	<span class="n">one_connection_terminals</span> <span class="o">=</span> <span class="p">(</span><span class="n">non_floating_exploded_terms</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">one_connection_terminals_list</span> <span class="o">=</span> <span class="n">one_connection_terminals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">one_connection_terminals</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="n">problematic_terminals_list</span> <span class="o">=</span> <span class="n">one_connection_terminals_list</span> <span class="o">+</span> <span class="n">floating_terminals</span>
	<span class="n">terminals_with_trafo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_trafos</span><span class="p">[</span><span class="s1">&#39;buslv.cterm&#39;</span><span class="p">],</span> <span class="n">df_trafos</span><span class="p">[</span><span class="s1">&#39;bushv.cterm&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">problematic_terminals_list_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">problematic_terminals_list</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terminals_with_trafo</span><span class="p">]</span>

	<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">terminals</span> <span class="ow">in</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">terminals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">problematic_terminals_list_2</span> <span class="ow">and</span> <span class="n">terminals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">problematic_terminals_list_2</span><span class="p">:</span>
			<span class="c1"># print(index)</span>
			<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="c1"># Drop lines corresponding to the isolated tieline in the north-west (near Schrding)</span>
	<span class="c1">#df_lines.drop([&#39;ElmLne_577&#39;, &#39;ElmLne_296&#39;, &#39;ElmLne_294&#39;, &#39;ElmLne_298&#39;], inplace=True)</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;w96001615|w95975626|w95978046|w123810051&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="c1"># Drop lines corresponding to the connection between the Kaprun substation and the Kaprun power plant</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;w823585280|w823585294_seg_1|w823585294_seg_2|w823585293&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="c1"># Drop lines that start and end at the same substation</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">term</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">term</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="c1"># Drop terminals that don&#39;t have any line connected to them</span>
	<span class="n">used_subs</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">used_subs</span><span class="p">]</span>

	<span class="k">return</span> <span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span></div>


<div class="viewcode-block" id="generate_loads"><a class="viewcode-back" href="../api.html#main.generate_loads">[docs]</a><span class="k">def</span> <span class="nf">generate_loads</span><span class="p">(</span><span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create data for the loads based on the model from https://www.energiemosaik.at/</span>

<span class="sd">	:param pd.DataFrame df_subs: terminals DataFrame</span>
<span class="sd">	:return: loads DataFrame</span>
<span class="sd">	:rtype: pd.DataFrame</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">df_loads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/loads_energiemosaik.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
	<span class="n">df_loads</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Gemeindecode&#39;</span><span class="p">:</span> <span class="s1">&#39;GKZ&#39;</span><span class="p">,</span> <span class="s1">&#39;Gemeindename&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
							 <span class="s1">&#39;Energieverbrauch insgesamt (MWh / a)&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy consumption (MWh/year)&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="n">shp_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/maps/austria_gemeinde_2/austria_gemeinde_2.shp&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
	<span class="n">shp_df</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">shp_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
	<span class="n">shp_df</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">shp_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">shp_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;GKZ&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="n">df_loads</span> <span class="o">=</span> <span class="n">df_loads</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shp_df</span><span class="p">[[</span><span class="s1">&#39;GKZ&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GKZ&#39;</span><span class="p">)</span>
	<span class="n">loads_centroids</span> <span class="o">=</span> <span class="n">df_loads</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

	<span class="n">u_terminals</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_subs</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;virtual terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;tieline terminal&#39;</span><span class="p">])]</span>
	<span class="n">point_terminals</span> <span class="o">=</span> <span class="n">u_terminals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">u_terminals</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">polygon_terminals</span> <span class="o">=</span> <span class="n">u_terminals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">u_terminals</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">u_terminals_centroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">point_terminals</span><span class="p">,</span> <span class="n">polygon_terminals</span><span class="p">])</span>

	<span class="c1"># nt stands for &quot;nearest terminal&quot;</span>
	<span class="n">nt_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">haversine_vector</span><span class="p">(</span><span class="n">loads_centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">u_terminals_centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">unit</span><span class="o">=</span><span class="n">Unit</span><span class="o">.</span><span class="n">KILOMETERS</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">nt_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">haversine_vector</span><span class="p">(</span><span class="n">loads_centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">u_terminals_centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">unit</span><span class="o">=</span><span class="n">Unit</span><span class="o">.</span><span class="n">KILOMETERS</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

	<span class="n">loads_assigned_terminals</span> <span class="o">=</span> <span class="p">[</span><span class="n">u_terminals_centroids</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nt_idx</span><span class="p">]</span>
	<span class="n">loads_dist_to_terminal</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">nt_dist</span><span class="p">]</span>

	<span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;assigned_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loads_assigned_terminals</span>
	<span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;dist_to_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loads_dist_to_terminal</span>

	<span class="c1"># Convert &quot;GKZ and  &quot;dist_to_term&quot; column to string type for visualization in QGIS</span>
	<span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;GKZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;GKZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;dist_to_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;dist_to_term&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

	<span class="c1"># Aggregate (sum) energy consumption for all loads that have the same terminal assigned</span>
	<span class="n">df_loads</span> <span class="o">=</span> <span class="n">df_loads</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;assigned_term&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;GKZ&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
																<span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
																<span class="s1">&#39;Energy consumption (MWh/year)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
																<span class="s1">&#39;dist_to_term&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)})</span>

	<span class="k">return</span> <span class="n">df_loads</span></div>


<div class="viewcode-block" id="calculate_load_nominal_value_different_days"><a class="viewcode-back" href="../api.html#main.calculate_load_nominal_value_different_days">[docs]</a><span class="k">def</span> <span class="nf">calculate_load_nominal_value_different_days</span><span class="p">(</span><span class="n">df_loads</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">load_profile</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Calculate nominal value for the load using the load profile of a certain day</span>

<span class="sd">	:param pd.DataFrame df_loads: loads DataFrame</span>
<span class="sd">	:param pd.DataFrame load_profile: load profile of one day</span>
<span class="sd">	:return: loads DataFrame with nominal value for the power of the loads</span>
<span class="sd">	:rtype: pd.DataFrame</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">power_2021_MW</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/1h_load_profile_2021.csv&#39;</span><span class="p">)[</span><span class="s1">&#39;Power [MW]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">mean_daily_ec_2021_MWh_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">power_2021_MW</span><span class="p">)</span><span class="o">/</span><span class="mi">365</span>  <span class="c1"># ec := energy consumed</span>
	<span class="n">power_lp_MW</span> <span class="o">=</span> <span class="n">load_profile</span><span class="p">[</span><span class="s1">&#39;Power [MW]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># lp := load profile</span>
	<span class="n">energy_lp_MWh_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">power_lp_MW</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="c1"># Variation from the daily mean of the energy consumed in a day with the defined load_profile</span>
	<span class="n">variation</span> <span class="o">=</span> <span class="p">(</span><span class="n">energy_lp_MWh_day</span> <span class="o">-</span> <span class="n">mean_daily_ec_2021_MWh_day</span><span class="p">)</span><span class="o">/</span><span class="n">mean_daily_ec_2021_MWh_day</span>

	<span class="c1"># Mean value of daily Energy consumed in each Gemeinde [MWh/day]</span>
	<span class="n">gem_daily_ec</span> <span class="o">=</span> <span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;Energy consumption (MWh/year)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">/</span><span class="mi">365</span>
	<span class="c1"># Estimated Energy consumed with load profile in each Gemeinde [MWh/day]</span>
	<span class="n">estimated_energy</span> <span class="o">=</span> <span class="n">gem_daily_ec</span> <span class="o">+</span> <span class="p">(</span><span class="n">gem_daily_ec</span> <span class="o">*</span> <span class="n">variation</span><span class="p">)</span>
	<span class="c1"># Estimated Power consumed with load profile in each Gemeinde [MW]</span>
	<span class="n">estimated_power</span> <span class="o">=</span> <span class="n">estimated_energy</span><span class="o">/</span><span class="mi">24</span>

	<span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;Nominal Value (MW)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimated_power</span>

	<span class="k">return</span> <span class="n">df_loads</span></div>


<div class="viewcode-block" id="calculate_load_nominal_value_year_average"><a class="viewcode-back" href="../api.html#main.calculate_load_nominal_value_year_average">[docs]</a><span class="k">def</span> <span class="nf">calculate_load_nominal_value_year_average</span><span class="p">(</span><span class="n">df_loads</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Calculate nominal value for the loads based on the load profile of the whole year</span>

<span class="sd">	:param pd.DataFrame df_loads: loads DataFrame</span>
<span class="sd">	:return: loads DataFrame with nominal value for the power of the loads</span>
<span class="sd">	:rytpe: pd.DataFrame</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">power_2021_MW</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/15min_load_profile_2021.csv&#39;</span><span class="p">)[</span><span class="s1">&#39;Power [MW]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">power_2021_normalized_MW</span> <span class="o">=</span> <span class="n">power_2021_MW</span><span class="o">/</span><span class="n">power_2021_MW</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
	<span class="n">ec_normalized_MWh_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">power_2021_normalized_MW</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
	<span class="n">P_nom_normalized_MW</span> <span class="o">=</span> <span class="n">ec_normalized_MWh_year</span><span class="o">/</span><span class="p">(</span><span class="mi">365</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
	<span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;Nominal Value (MW)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_loads</span><span class="p">[</span><span class="s1">&#39;Energy consumption (MWh/year)&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ec_normalized_MWh_year</span><span class="p">)</span><span class="o">*</span><span class="n">P_nom_normalized_MW</span>
	<span class="c1">#df_loads[&#39;Nominal Value (MW)&#39;] = df_loads[&#39;Energy consumption (MWh/year)&#39;]/ec_normalized_MWh_year</span>

	<span class="k">return</span> <span class="n">df_loads</span></div>


<div class="viewcode-block" id="create_pf_csv"><a class="viewcode-back" href="../api.html#main.create_pf_csv">[docs]</a><span class="k">def</span> <span class="nf">create_pf_csv</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_pp_agg</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_loads</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create csv files to generate the PowerFactory model</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: terminals DataFrame</span>
<span class="sd">	:param pd.DataFrame df_pp_agg: power plants DataFrame</span>
<span class="sd">	:param pd.DataFrame df_loads: loads DataFrame</span>
<span class="sd">	:return: 0</span>
<span class="sd">	:rtype: int</span>

<span class="sd">	TODO: Detailed explanation</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">lines_df_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">,</span><span class="s1">&#39;bus1.cterm&#39;</span><span class="p">,</span><span class="s1">&#39;bus2.cterm&#39;</span><span class="p">,</span><span class="s1">&#39;bus1.__switch__.on_off&#39;</span><span class="p">,</span><span class="s1">&#39;bus2.__switch__.on_off&#39;</span><span class="p">,</span><span class="s1">&#39;dline&#39;</span><span class="p">,</span><span class="s1">&#39;typ_id&#39;</span><span class="p">,</span><span class="s1">&#39;nlnum&#39;</span><span class="p">,</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span><span class="s1">&#39;GPScoords&#39;</span><span class="p">])</span>
	<span class="n">substations_df_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">,</span> <span class="s1">&#39;uknom&#39;</span><span class="p">,</span> <span class="s1">&#39;cpZone&#39;</span><span class="p">,</span> <span class="s1">&#39;cpArea&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">])</span>
	<span class="n">pp_df_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;cterm&#39;</span><span class="p">,</span> <span class="s1">&#39;sgn&#39;</span><span class="p">])</span>
	<span class="n">loads_df_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">,</span> <span class="s1">&#39;bus1&#39;</span><span class="p">,</span> <span class="s1">&#39;plini&#39;</span><span class="p">,</span> <span class="s1">&#39;bus1.__switch__.on_off&#39;</span><span class="p">])</span>
	<span class="n">sta_vmea_df_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pbusbar&#39;</span><span class="p">,</span> <span class="s1">&#39;i_orient&#39;</span><span class="p">,</span> <span class="s1">&#39;nphase&#39;</span><span class="p">,</span> <span class="s1">&#39;ElmComp&#39;</span><span class="p">])</span>
	<span class="n">sta_pqmea_df_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pbusbar&#39;</span><span class="p">,</span> <span class="s1">&#39;i_orient&#39;</span><span class="p">,</span> <span class="s1">&#39;nphase&#39;</span><span class="p">,</span> <span class="s1">&#39;ElmComp&#39;</span><span class="p">])</span>

	<span class="n">substations_df_pf</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">index</span>
	<span class="n">substations_df_pf</span><span class="p">[[</span><span class="s1">&#39;uknom&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_subs</span><span class="p">[[</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">substations_df_pf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
	<span class="n">substations_df_pf</span><span class="p">[[</span><span class="s1">&#39;cpZone&#39;</span><span class="p">,</span> <span class="s1">&#39;cpArea&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_subs</span><span class="p">[[</span><span class="s1">&#39;Zone&#39;</span><span class="p">,</span> <span class="s1">&#39;Area&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">substations_df_pf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

	<span class="n">lines_df_pf</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ElmLne_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
	<span class="n">d_type</span> <span class="o">=</span> <span class="p">{</span><span class="mf">110.0</span><span class="p">:</span> <span class="s1">&#39;TypLne_1&#39;</span><span class="p">,</span> <span class="mf">220.0</span><span class="p">:</span> <span class="s1">&#39;TypLne_2&#39;</span><span class="p">,</span> <span class="mf">380.0</span><span class="p">:</span> <span class="s1">&#39;TypLne_3&#39;</span><span class="p">}</span>
	<span class="n">lines_df_pf</span><span class="p">[</span><span class="s1">&#39;typ_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">d_type</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">lines_df_pf</span><span class="p">[[</span><span class="s1">&#39;bus1.cterm&#39;</span><span class="p">,</span><span class="s1">&#39;bus2.cterm&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">substations</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
	<span class="n">lines_df_pf</span><span class="p">[[</span><span class="s1">&#39;bus1.__switch__.on_off&#39;</span><span class="p">,</span> <span class="s1">&#39;bus2.__switch__.on_off&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
	<span class="n">df_lines</span><span class="o">.</span><span class="n">circuits</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">circuits</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">lines_df_pf</span><span class="p">[[</span><span class="s1">&#39;dline&#39;</span><span class="p">,</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;GPScoords&#39;</span><span class="p">,</span> <span class="s1">&#39;nlnum&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="p">[[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;circuits&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">lines_df_pf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

	<span class="n">pp_df_pf</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SM_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_pp_agg</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
	<span class="n">pp_df_pf</span><span class="p">[[</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;cterm&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_pp_agg</span><span class="p">[[</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned_term&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pp_df_pf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
	<span class="n">pp_df_pf</span><span class="p">[</span><span class="s1">&#39;sgn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_pp_agg</span><span class="p">[</span><span class="s1">&#39;capacity(MW)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">0.9</span> <span class="k">if</span> <span class="n">df_pp_agg</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PV&#39;</span><span class="p">,</span> <span class="s1">&#39;Wind&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">df_pp_agg</span><span class="p">[</span><span class="s1">&#39;capacity(MW)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_pp_agg</span><span class="p">))]</span>
	<span class="n">pp_df_pf</span><span class="p">[</span><span class="s1">&#39;ip_ctrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">pp_df_pf</span><span class="p">[</span><span class="s1">&#39;ip_ctrl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df_pf</span><span class="p">[</span><span class="s1">&#39;sgn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>

	<span class="n">loads_df_pf</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ElmLod_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_loads</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
	<span class="n">loads_df_pf</span><span class="p">[[</span><span class="s1">&#39;bus1&#39;</span><span class="p">,</span> <span class="s1">&#39;plini&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_loads</span><span class="p">[[</span><span class="s1">&#39;assigned_term&#39;</span><span class="p">,</span> <span class="s1">&#39;Nominal Value (MW)&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">loads_df_pf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
	<span class="n">loads_df_pf</span><span class="p">[</span><span class="s1">&#39;bus1.__switch__.on_off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="n">loads_df_pf</span><span class="p">[</span><span class="s1">&#39;scale0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>

	<span class="c1"># Generate csv files for measured voltage and measured power for Wind and PV controllers</span>
	<span class="n">wind_pv_df</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pp_df_pf</span><span class="o">.</span><span class="n">template</span> <span class="o">==</span> <span class="s1">&#39;Wind&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pp_df_pf</span><span class="o">.</span><span class="n">template</span> <span class="o">==</span> <span class="s1">&#39;PV&#39;</span><span class="p">)]</span>

	<span class="n">sta_vmea_df_pf</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Vmea_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">wind_pv_df</span><span class="o">.</span><span class="n">loc_name</span><span class="p">]</span>
	<span class="n">sta_vmea_df_pf</span><span class="p">[</span><span class="s1">&#39;pbusbar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ElmTerm_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">wind_pv_df</span><span class="o">.</span><span class="n">loc_name</span><span class="p">]</span>
	<span class="n">sta_vmea_df_pf</span><span class="p">[</span><span class="s1">&#39;ElmComp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ElmComp_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">wind_pv_df</span><span class="o">.</span><span class="n">loc_name</span><span class="p">]</span>
	<span class="n">sta_vmea_df_pf</span><span class="p">[[</span><span class="s1">&#39;i_orient&#39;</span><span class="p">,</span> <span class="s1">&#39;nphase&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>

	<span class="n">loc_name_wind</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PQmea_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">wind_pv_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wind_pv_df</span><span class="o">.</span><span class="n">template</span> <span class="o">==</span> <span class="s1">&#39;Wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc_name</span><span class="p">]</span>
	<span class="n">loc_name_solar_p</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pmea_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">wind_pv_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wind_pv_df</span><span class="o">.</span><span class="n">template</span> <span class="o">==</span> <span class="s1">&#39;PV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc_name</span><span class="p">]</span>
	<span class="n">loc_name_solar_q</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Qmea_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">wind_pv_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wind_pv_df</span><span class="o">.</span><span class="n">template</span> <span class="o">==</span> <span class="s1">&#39;PV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc_name</span><span class="p">]</span>
	<span class="n">sta_pqmea_df_pf</span><span class="p">[</span><span class="s1">&#39;loc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc_name_wind</span> <span class="o">+</span> <span class="n">loc_name_solar_p</span> <span class="o">+</span> <span class="n">loc_name_solar_q</span>
	<span class="n">sta_pqmea_df_pf</span><span class="p">[</span><span class="s1">&#39;pbusbar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ElmTerm_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">sta_pqmea_df_pf</span><span class="o">.</span><span class="n">loc_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
	<span class="n">sta_pqmea_df_pf</span><span class="p">[</span><span class="s1">&#39;ElmComp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ElmComp_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sm_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">sm_name</span> <span class="ow">in</span> <span class="n">sta_pqmea_df_pf</span><span class="o">.</span><span class="n">loc_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
	<span class="n">sta_pqmea_df_pf</span><span class="p">[[</span><span class="s1">&#39;i_orient&#39;</span><span class="p">,</span> <span class="s1">&#39;nphase&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>

	<span class="c1"># Write csv files</span>
	<span class="n">substations_df_pf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/ElmTerm.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">lines_df_pf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/ElmLne.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">pp_df_pf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/ElmTemplate.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">loads_df_pf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/ElmLod.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">sta_vmea_df_pf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../examples/AustrianGrid/csv/FromTemplates/StaVmea.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">sta_pqmea_df_pf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../examples/AustrianGrid/csv/FromTemplates/StaPqmea.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="qgis"><a class="viewcode-back" href="../api.html#main.qgis">[docs]</a><span class="k">def</span> <span class="nf">qgis</span><span class="p">(</span><span class="n">df_lines</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_trafos</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_pp</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
		 <span class="n">df_pp_agg</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_loads</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create csv files to visualize data using QGIS desktop application</span>

<span class="sd">	:param pd.DataFrame df_lines: lines DataFrame</span>
<span class="sd">	:param pd.DataFrame df_subs: terminals DataFrame</span>
<span class="sd">	:param pd.DataFrame df_trafos: transformers plants DataFrame</span>
<span class="sd">	:param pd.DataFrame df2: substations DataFrame with original geometries (before converting to circles)</span>
<span class="sd">	:param pd.DataFrame df_pp: power plants DataFrame</span>
<span class="sd">	:param pd.DataFrame df_pp_agg: power plants DataFrame with aggregated distributed generation</span>
<span class="sd">	:param pd.DataFrame df_loads: loads DataFrame</span>
<span class="sd">	:return: 0</span>
<span class="sd">	:rtype: int</span>

<span class="sd">	Create csv files with attributes and WKT geometries to visualize the data of the model in QGIS.</span>
<span class="sd">	This way layers can be added to the QGIS project using the &quot;Add Delimited Text Layer...&quot; operation.</span>
<span class="sd">	The terminals had to be separated into two different files because QGIS can only read data with the same WKT type</span>
<span class="sd">	for each file.</span>
<span class="sd">	For the power plants also two files are created: one contains the power plants at the original location and before</span>
<span class="sd">	being aggregated and the other contains the aggregated power plants located at the position where their assigned</span>
<span class="sd">	terminal is positioned.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">df_qgis_lines</span> <span class="o">=</span> <span class="n">df_lines</span><span class="p">[[</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;substations&#39;</span><span class="p">]]</span>
	<span class="n">df_qgis_lines</span><span class="p">[</span><span class="s1">&#39;sh_lines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">LineString</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
	<span class="n">df_qgis_lines</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lines</span><span class="o">.</span><span class="n">index</span>

	<span class="n">subs_1</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_subs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df_subs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
	<span class="n">subs_2</span> <span class="o">=</span> <span class="n">df_subs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_subs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_subs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">))]</span>
	<span class="n">df_qgis_terminals</span> <span class="o">=</span> <span class="n">subs_1</span><span class="p">[[</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Area&#39;</span><span class="p">,</span> <span class="s1">&#39;Zone&#39;</span><span class="p">]]</span>
	<span class="n">df_qgis_terminals_nodes</span> <span class="o">=</span> <span class="n">subs_2</span><span class="p">[[</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Area&#39;</span><span class="p">,</span> <span class="s1">&#39;Zone&#39;</span><span class="p">]]</span>
	<span class="n">df_qgis_terminals</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs_1</span><span class="o">.</span><span class="n">index</span>
	<span class="n">df_qgis_terminals_nodes</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs_2</span><span class="o">.</span><span class="n">index</span>
	<span class="n">df_qgis_terminals</span><span class="p">[</span><span class="s1">&#39;sh_terminals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs_1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">LineString</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
	<span class="n">df_qgis_terminals_nodes</span><span class="p">[</span><span class="s1">&#39;sh_terminals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs_2</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

	<span class="n">l1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">df_trafos</span><span class="o">.</span><span class="n">loc_name</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_trafos</span><span class="p">))</span> <span class="k">if</span> \
	 <span class="n">term</span> <span class="o">==</span> <span class="n">df_trafos</span><span class="p">[</span><span class="s1">&#39;buslv.cterm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">term</span> <span class="o">==</span> <span class="n">df_trafos</span><span class="p">[</span><span class="s1">&#39;bushv.cterm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> \
	 <span class="n">term</span> <span class="ow">in</span> <span class="n">df_qgis_terminals</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
	<span class="n">l2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">df_trafos</span><span class="o">.</span><span class="n">loc_name</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_trafos</span><span class="p">))</span> <span class="k">if</span> \
	 <span class="n">term</span> <span class="o">==</span> <span class="n">df_trafos</span><span class="p">[</span><span class="s1">&#39;buslv.cterm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">term</span> <span class="o">==</span> <span class="n">df_trafos</span><span class="p">[</span><span class="s1">&#39;bushv.cterm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> \
	 <span class="n">term</span> <span class="ow">in</span> <span class="n">df_qgis_terminals_nodes</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

	<span class="n">df_qgis_terminals</span><span class="p">[</span><span class="s1">&#39;trafos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1</span>
	<span class="n">df_qgis_terminals</span><span class="p">[</span><span class="s1">&#39;trafos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">df_qgis_terminals_nodes</span><span class="p">[</span><span class="s1">&#39;trafos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l2</span>
	<span class="n">df_qgis_terminals_nodes</span><span class="p">[</span><span class="s1">&#39;trafos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

	<span class="n">df_subs_og</span> <span class="o">=</span> <span class="n">terminals</span><span class="o">.</span><span class="n">format_substations</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
	<span class="n">df_qgis_subs_og</span> <span class="o">=</span> <span class="n">df_subs_og</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_subs_og</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df_subs_og</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">isna</span><span class="p">()][[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
	<span class="n">df_qgis_subs_og</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_qgis_subs_og</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>

	<span class="n">df_qgis_pp_og</span> <span class="o">=</span> <span class="n">df_pp</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;capacity(MW)&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned_term&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_to_term&#39;</span><span class="p">]]</span>
	<span class="n">df_qgis_pp_og</span><span class="p">[</span><span class="s1">&#39;sh_pp_og&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="k">for</span> <span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_pp</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">df_pp</span><span class="o">.</span><span class="n">lat</span><span class="p">)]</span> <span class="c1"># Raises a deprecation warning but it&#39;s fine to ignore it (https://shapely.readthedocs.io/en/stable/migration.html#creating-numpy-arrays-of-geometry-objects)</span>
	<span class="n">df_qgis_pp_og</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SM_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_pp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

	<span class="n">terminals_centroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_qgis_terminals_nodes</span><span class="o">.</span><span class="n">sh_terminals</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
									 <span class="n">df_qgis_terminals</span><span class="o">.</span><span class="n">sh_terminals</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>

	<span class="n">df_qgis_pp_agg</span> <span class="o">=</span> <span class="n">df_pp_agg</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;capacity(MW)&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned_term&#39;</span><span class="p">]]</span>
	<span class="n">df_qgis_pp_agg</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">terminals_centroids</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_qgis_pp_agg</span><span class="o">.</span><span class="n">assigned_term</span><span class="p">]</span>
	<span class="n">df_qgis_pp_agg</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">terminals_centroids</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_qgis_pp_agg</span><span class="o">.</span><span class="n">assigned_term</span><span class="p">]</span>
	<span class="n">df_qgis_pp_agg</span><span class="p">[</span><span class="s1">&#39;sh_pp_agg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat</span><span class="p">,</span><span class="n">lon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_qgis_pp_agg</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">df_qgis_pp_agg</span><span class="o">.</span><span class="n">lon</span><span class="p">)]</span>
	<span class="n">df_qgis_pp_agg</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SM_</span><span class="si">{0:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_pp_agg</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

	<span class="n">df_qgis_loads</span> <span class="o">=</span> <span class="n">df_loads</span><span class="p">[[</span><span class="s1">&#39;GKZ&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy consumption (MWh/year)&#39;</span><span class="p">,</span> <span class="s1">&#39;Nominal Value (MW)&#39;</span><span class="p">,</span> <span class="s1">&#39;assigned_term&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_to_term&#39;</span><span class="p">]]</span>
	<span class="c1">#df_qgis_loads[&#39;sh_loads&#39;] = df_loads.geometry.apply(lambda p: p.centroid)  # Original location of the loads</span>
	<span class="n">df_qgis_loads_lat</span> <span class="o">=</span> <span class="p">[</span><span class="n">terminals_centroids</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_qgis_loads</span><span class="o">.</span><span class="n">assigned_term</span><span class="p">]</span>
	<span class="n">df_qgis_loads_lon</span> <span class="o">=</span> <span class="p">[</span><span class="n">terminals_centroids</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_qgis_loads</span><span class="o">.</span><span class="n">assigned_term</span><span class="p">]</span>
	<span class="n">df_qgis_loads</span><span class="p">[</span><span class="s1">&#39;sh_loads_agg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat</span><span class="p">,</span><span class="n">lon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_qgis_loads_lat</span><span class="p">,</span> <span class="n">df_qgis_loads_lon</span><span class="p">)]</span>  <span class="c1"># Aggregated loads located at nearest terminal</span>

	<span class="n">df_qgis_lines</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_lines.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_qgis_terminals</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_terminals.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_qgis_terminals_nodes</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_terminals_nodes.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_qgis_subs_og</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_subs_shape.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_qgis_pp_og</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_power_plants.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_qgis_pp_agg</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_power_plants_aggregated.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">df_qgis_loads</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/qgis_loads.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="k">return</span> <span class="mi">0</span></div>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- EXECUTION STARTED ---&#39;</span><span class="p">)</span>

	<span class="c1"># print(&#39;Querying OSM for lines...&#39;)</span>
	<span class="c1"># df1 = query_overpass(lines.query_lines())</span>
	<span class="c1"># print(&#39;Querying OSM for terminals...&#39;)</span>
	<span class="c1"># df2 = query_overpass(terminals.query_terminals())</span>
	<span class="c1"># print(&#39;Querying OSM for power plants...&#39;)</span>
	<span class="c1"># df3 = query_overpass(power_plants.query_power_plants())</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading lines data from json file...&#39;</span><span class="p">)</span>
	<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Lines/lines_OSM_read.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading terminals data from json file...&#39;</span><span class="p">)</span>
	<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Substations/substations_OSM_read.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading power plants data from json file...&#39;</span><span class="p">)</span>
	<span class="n">df3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Power_Plants/power_plants_OSM_read.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading load profiles data from csv files...&#39;</span><span class="p">)</span>
	<span class="n">load_profile_summer_day_workday</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/1h_load_profile_20_07_2021.csv&#39;</span><span class="p">)</span>
	<span class="n">load_profile_summer_day_weekend</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/1h_load_profile_25_07_2021.csv&#39;</span><span class="p">)</span>
	<span class="n">load_profile_winter_day_workday</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/1h_load_profile_16_02_2021.csv&#39;</span><span class="p">)</span>
	<span class="n">load_profile_winter_day_weekend</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/raw_data/Loads/1h_load_profile_21_02_2021.csv&#39;</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Formatting data...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">format_lines</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">terminals</span><span class="o">.</span><span class="n">format_substations</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
	<span class="n">df_pp</span> <span class="o">=</span> <span class="n">power_plants</span><span class="o">.</span><span class="n">format_power_plants</span><span class="p">(</span><span class="n">df3</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting substations to circular areas...&#39;</span><span class="p">)</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">terminals</span><span class="o">.</span><span class="n">convert_substation_areas</span><span class="p">(</span><span class="n">df_subs</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaning data...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">delete_lines_in_subs</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">handle_nan</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">correct_incoherent_cables</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">correct_incoherent_combinations</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span>
	<span class="n">df_pp</span> <span class="o">=</span> <span class="n">power_plants</span><span class="o">.</span><span class="n">convert_capacity</span><span class="p">(</span><span class="n">df_pp</span><span class="p">)</span>
	<span class="n">df_pp</span> <span class="o">=</span> <span class="n">power_plants</span><span class="o">.</span><span class="n">remove_redundant_generators</span><span class="p">(</span><span class="n">power_plants</span><span class="o">.</span><span class="n">cluster_data</span><span class="p">(</span><span class="n">df_pp</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">df_pp</span><span class="p">)</span>
	<span class="n">df_pp</span> <span class="o">=</span> <span class="n">power_plants</span><span class="o">.</span><span class="n">update_solar</span><span class="p">(</span><span class="n">df_pp</span><span class="p">)</span>
	<span class="n">df_pp</span> <span class="o">=</span> <span class="n">power_plants</span><span class="o">.</span><span class="n">reassign_source_values</span><span class="p">(</span><span class="n">df_pp</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Splitting lines by voltage...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">split_lines_by_voltage</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Splitting lines for middle connections...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">split_middle_connections</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assigning terminals to lines...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span> <span class="o">=</span> <span class="n">assign_substation_to_lines</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">)</span>
	<span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span> <span class="o">=</span> <span class="n">create_virtual_terminals</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handling lines with floating ends...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span> <span class="o">=</span> <span class="n">handle_floating_ends</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Joining line segments...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">join_lines</span><span class="p">(</span><span class="n">df_lines</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assigning areas and zones to terminals...&#39;</span><span class="p">)</span>
	<span class="n">df_subs</span> <span class="o">=</span> <span class="n">terminals</span><span class="o">.</span><span class="n">assign_areas_and_zones</span><span class="p">(</span><span class="n">df_subs</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating transformers data...&#39;</span><span class="p">)</span>
	<span class="n">df_trafos</span> <span class="o">=</span> <span class="n">terminals</span><span class="o">.</span><span class="n">create_trafos_csv</span><span class="p">(</span><span class="n">df_subs</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Handling cases still containing troublesome data...&#39;</span><span class="p">)</span>
	<span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span> <span class="o">=</span> <span class="n">handle_special_cases</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">,</span> <span class="n">df_trafos</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assigning terminals to power plants...&#39;</span><span class="p">)</span>
	<span class="n">df_pp</span><span class="p">,</span> <span class="n">df_pp_agg</span> <span class="o">=</span> <span class="n">assign_substation_to_power_plants</span><span class="p">(</span><span class="n">df_pp</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing loads and assigning them to the closest terminal...&#39;</span><span class="p">)</span>
	<span class="n">df_loads</span> <span class="o">=</span> <span class="n">generate_loads</span><span class="p">(</span><span class="n">df_subs</span><span class="p">)</span>

	<span class="c1"># print(&#39;Calculating nominal value for the loads using different days of the year...&#39;)</span>
	<span class="c1"># df_loads = calculate_load_nominal_value_different_days(df_loads, load_profile_summer_day_workday)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating nominal value for the loads using a year average...&#39;</span><span class="p">)</span>
	<span class="n">df_loads</span> <span class="o">=</span> <span class="n">calculate_load_nominal_value_year_average</span><span class="p">(</span><span class="n">df_loads</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing data to csv...&#39;</span><span class="p">)</span>
	<span class="n">create_pf_csv</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">,</span> <span class="n">df_pp_agg</span><span class="p">,</span> <span class="n">df_loads</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running tests...&#39;</span><span class="p">)</span>
	<span class="n">tests</span><span class="o">.</span><span class="n">main_tests</span><span class="p">(</span><span class="n">df_lines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_lines</span><span class="o">.</span><span class="n">connecting_segments</span> <span class="o">!=</span> <span class="s1">&#39;chained_line&#39;</span><span class="p">],</span> <span class="n">df_subs</span><span class="p">,</span> <span class="n">df_pp_agg</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validating csv format...&#39;</span><span class="p">)</span>
	<span class="n">lines_csv_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/ElmLne.csv&#39;</span><span class="p">)</span>
	<span class="n">terminals_csv_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/csv/generated/ElmTerm.csv&#39;</span><span class="p">)</span>
	<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ElmLne&#39;</span><span class="p">:</span> <span class="n">lines_csv_df</span><span class="p">,</span> <span class="s1">&#39;ElmTerm&#39;</span><span class="p">:</span> <span class="n">terminals_csv_df</span><span class="p">}</span>
	<span class="n">validation</span> <span class="o">=</span> <span class="n">validate</span><span class="o">.</span><span class="n">NetworkValidator</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
	<span class="n">validation</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating files for QGIS visualization...&#39;</span><span class="p">)</span>
	<span class="n">qgis</span><span class="p">(</span><span class="n">df_lines</span><span class="p">,</span> <span class="n">df_subs</span><span class="p">,</span> <span class="n">df_trafos</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df_pp</span><span class="p">,</span> <span class="n">df_pp_agg</span><span class="p">,</span> <span class="n">df_loads</span><span class="p">)</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- EXECUTION ENDED ---&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Vettoretti Denis, Basel Morsy, Ribas Sobreviela Jordi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>